<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Fit to Notion Sync</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="card">
      <h1>Google Fit to Notion Sync</h1>
      <p>Status: <span id="status" class="status"></span></p>
      <p><a href="/auth" id="authLink">Authenticate with Google Fit</a></p>
      <p><button id="syncButton">Trigger manual sync</button></p>
      <div id="countdown"></div>
      <div id="latestData"></div>
    </div>

    <script>
      // Use secure WebSocket connection based on the page protocol
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(`${protocol}//${window.location.host}`);

      const statusElement = document.getElementById("status");
      const countdownElement = document.getElementById("countdown");
      const syncButton = document.getElementById("syncButton");
      const latestDataElement = document.getElementById("latestData");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "authStatus") {
          statusElement.textContent = data.isAuthenticated
            ? "Authenticated"
            : "Not authenticated";
          statusElement.className = `status ${
            data.isAuthenticated ? "authenticated" : "not-authenticated"
          }`;
        } else if (data.type === "countdown") {
          countdownElement.textContent = `Next auto update in: ${data.timeLeft}`;
        } else if (data.type === "syncCompleted") {
          alert("Sync completed successfully!");
          fetchLatestData();
        }
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        countdownElement.textContent =
          "WebSocket connection error. Please refresh the page.";
      };

      syncButton.addEventListener("click", () => {
        fetch("/sync")
          .then((response) => response.text())
          .then((result) => {
            alert(result);
            fetchLatestData();
          })
          .catch((error) => console.error("Error:", error));
      });

      function fetchLatestData() {
        fetch("/api/fitness-data")
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              const latestDate = Object.keys(data.data).sort().pop();
              const latestData = data.data[latestDate];
              latestDataElement.innerHTML = `
              <h2>Latest Fitness Data (${latestDate})</h2>
              <p>Steps: ${latestData.steps}</p>
              <p>Distance: ${latestData.distance.toFixed(2)} km</p>
              <p>Calories: ${latestData.calories}</p>
              <p>Active Minutes: ${latestData.activeMinutes}</p>
            `;
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      fetchLatestData();
    </script>
  </body>
</html>
